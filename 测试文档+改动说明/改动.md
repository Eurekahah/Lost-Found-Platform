## 数据库
1. 增加表user_conversations用于加快查找会话
   ## 用户会话表

| 字段名称              | 数据类型 | 约束条件                                                  | 翻译             |
| --------------------- | -------- | --------------------------------------------------------- | ---------------- |
| user1_id              | NUMBER   | NOT NULL    PRIMARY KEY                                              | 用户1 ID         |
| user2_id              | NUMBER   | NOT NULL    PRIMARY KEY                                   | 用户2 ID         |
| last_message_id       | NUMBER   | FOREIGN KEY, REFERENCES User_Messages(message_id) ON DELETE CASCADE | 最后消息ID       |
|unread_count           |NUMBER     |NOT NULL                                   | 未读消息个数  |
2. 增加answers表的外键 并且配置级联删除
```
        ALTER TABLE ANSWERS
        ADD CONSTRAINT fk_question
        FOREIGN KEY (QUESTION_ID)
        REFERENCES QUESTIONS (QUESTION_ID)
        ON DELETE CASCADE
```
3. 增加user_messages表的触发器 从而内部更新conversations表
   ```
        CREATE OR REPLACE TRIGGER UPDATE_UNREAD_COUNT_TRIGGER
        AFTER INSERT ON USER_MESSAGES
        FOR EACH ROW
        DECLARE
            v_count INTEGER;
        BEGIN
            -- 检查会话是否存在
            SELECT COUNT(*)
            INTO v_count
            FROM USER_CONVERSATIONS
            WHERE (USER1_ID = :NEW.SENDER_USER_ID AND USER2_ID = :NEW.RECEIVER_USER_ID);
            

            IF v_count > 0 THEN
                -- 会话存在，更新 UNREAD_COUNT
                UPDATE USER_CONVERSATIONS
                SET UNREAD_COUNT = UNREAD_COUNT + 1,
                    LAST_MESSAGE_ID = :NEW.MESSAGE_ID
                WHERE (USER1_ID = :NEW.SENDER_USER_ID AND USER2_ID = :NEW.RECEIVER_USER_ID);
                
            ELSE
                -- 会话不存在，插入新记录
                INSERT INTO USER_CONVERSATIONS (USER1_ID, USER2_ID, LAST_MESSAGE_ID, UNREAD_COUNT)
                VALUES (:NEW.SENDER_USER_ID, :NEW.RECEIVER_USER_ID, :NEW.MESSAGE_ID, 1);
            END IF;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE_APPLICATION_ERROR(-20001, 'Error in UPDATE_UNREAD_COUNT_TRIGGER: ' || SQLERRM);
        END;
    ```

4. 增加user_messages表的触发器 设置未读数量自减
```
        CREATE OR REPLACE TRIGGER DECREMENT_UNREAD_COUNT
        BEFORE UPDATE ON USER_MESSAGES
        FOR EACH ROW
        BEGIN
            IF :OLD.READ_STATUS = 'N' AND :NEW.READ_STATUS = 'Y' THEN
                UPDATE USER_CONVERSATIONS
                SET UNREAD_COUNT = UNREAD_COUNT - 1
                WHERE USER1_ID = :NEW.SENDER_USER_ID AND USER2_ID = :NEW.RECEIVER_USER_ID;
            END IF;
        END;
```
5. 设置所有表中作为主键的ID自增并且 always
   
## 公用数据结构
增加user_conversations数据结构 添加get set 方便写模版类
注意：请把以下代码完整复制到原来的数据结构位置（这些应该都是连着的）

```
    

    public class User_Conversations
    {
        public int User1_ID { get; set; }
        public int User2_ID { get; set; }
        public int Last_Message_ID { get; set; }
        public int Unread_Count {  get; set; }
    }


    public class User_Messages
    {
        public int Message_ID { get; set; }
        public string Message_Content { get; set; } // Corresponds to CLOB in SQL
        public string Read_Status { get; set; }
        public DateTime Send_Time { get; set; }
        public string Message_Type { get; set; }
        public int Sender_User_ID { get; set; }
        public int Receiver_User_ID { get; set; }
    }

    public class User_Posts
    {
        public int Post_ID { get; set; }
        public int User_ID { get; set; }
        public string Content { get; set; }
        public DateTime Post_Date { get; set; }
        public int Popularity { get; set; }
    }

    public class User_Relationships
    {
        public int Relation_ID { get; set; }
        public int User_ID1 { get; set; }
        public int User_ID2 { get; set; }
        public string Relation_Type { get; set; }
        public DateTime Established_Date { get; set; }
    }

    public class Follow_List
    {
        public int Follow_ID { get; set; }
        public int Follower_User_ID { get; set; }
        public int Followed_User_ID { get; set; }
        public DateTime Follow_Date { get; set; }
    }

    public class Questions
    {
        public int Question_ID { get; set; }
        public int Item_ID { get; set; }
        public int User_ID { get; set; }
        public string Question_Content { get; set; }
        public DateTime Question_Time { get; set; }

       
    }

    public class Answers
    {
        public int Answer_ID { get; set; }
        public int Question_ID { get; set; }
        public int User_ID { get; set; }
        public string Answer_Content { get; set; }
        public DateTime Answer_Date { get; set; }
    }
    


```

## 疑问
1. 最好提供用户头像的URL
2. 规定一下用户ID位数
3. 待测试实时聊天：不用该功能时可以把发送和撤回消息的await行注释掉